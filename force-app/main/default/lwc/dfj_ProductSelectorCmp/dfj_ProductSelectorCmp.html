<template>
  <div class="payment-selector-wrapper">
  <lightning-card>
    <div class="slds-m-around_medium">
      <template if:true={isLoadedSpinner}>
        <lightning-spinner alternative-text="Loading..." variant="brand">
        </lightning-spinner>
      </template>
    </div>
    
    <!-- Permission Error Display -->
    <template if:true={hasPermissionError}>
      <div class="slds-notify slds-notify_alert slds-alert_error slds-m-around_medium" role="alert">
        <span class="slds-assistive-text">error</span>
        <span class="slds-icon_container slds-icon-utility-error slds-m-right_x-small">
          <lightning-icon icon-name="utility:error" alternative-text="Error" variant="inverse" size="x-small"></lightning-icon>
        </span>
        <h2>{permissionErrorMessage}</h2>
      </div>
    </template>
    
    <template if:false={hasPermissionError}>
    <fieldset class="slds-box product-fieldset">
      <!-- Start Product Table - Modern Design -->
      <div class="product-table-container">
        <table class="product-table">
          <thead>
            <tr>
              <th class="col-product">
                <div class="header-content">
                  <lightning-icon icon-name="utility:package" size="xx-small" class="header-icon"></lightning-icon>
                  <span>Product</span>
                </div>
              </th>
              <th class="col-qty">
                <div class="header-content header-center">
                  <span>Qty</span>
                </div>
              </th>
              <th class="col-price">
                <div class="header-content header-center">
                  <span>Price</span>
                </div>
              </th>
              <th class="col-subtotal">
                <div class="header-content header-right">
                  <span>Subtotal</span>
                </div>
              </th>
              <th class="col-action">
                <div class="header-content header-right">
                  <button class="empty-basket-btn" onclick={deleteRecord} disabled={isClearAllDisabled} title="Empty Basket">
                    <lightning-icon icon-name="utility:delete" size="xx-small"></lightning-icon>
                    <span class="empty-basket-text">Clear All</span>
                  </button>
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            <template if:false={isProductAvailable}>
              <tr class="empty-state-row">
                <td colspan="5">
                  <div class="empty-state">
                    <div class="empty-state-icon">
                      <lightning-icon icon-name="utility:cart" size="large"></lightning-icon>
                    </div>
                    <p class="empty-state-text">Your basket is empty</p>
                    <p class="empty-state-subtext">Add products to get started</p>
                  </div>
                </td>
              </tr>
            </template>
            <template if:true={isProductAvailable}>
              <template for:each={productLineItems} for:item="pro" for:index="tabIndex">
                <tr key={pro.Id} class="product-row">
                  <td class="col-product">
                    <div class="product-name">
                      <div class="product-indicator"></div>
                      <span class="product-title">{pro.Name}</span>
                    </div>
                  </td>
                  <td class="col-qty">
                    <div class="qty-badge">{pro.Quantity}</div>
                  </td>
                  <td class="col-price">
                    <div class="price-value">
                      <lightning-formatted-number value={pro.UnitPrice} format-style="currency"
                        currency-code={pro.CurrencyIsoCode} currency-display-as="symbol">
                      </lightning-formatted-number>
                    </div>
                  </td>
                  <td class="col-subtotal">
                    <div class="subtotal-value">
                      <lightning-formatted-number value={pro.totalPrice} format-style="currency"
                        currency-code={pro.CurrencyIsoCode} currency-display-as="symbol">
                      </lightning-formatted-number>
                    </div>
                  </td>
                  <td class="col-action">
                    <lightning-button-icon icon-name="utility:delete" variant="bare" onclick={deleteRecord}
                      alternative-text="Delete" data-index={tabIndex} disabled={isActionButtonsDisabled}
                      class="delete-btn">
                    </lightning-button-icon>
                  </td>
                </tr>
              </template>
            </template>
          </tbody>
        </table>
      </div>
      <!-- End Product Table -->


    </fieldset>








    <!-- Start button section -->
    <div class="slds-p-top_large">

      <!-- layout used above -->
        <lightning-layout multiple-rows="true" horizontal-align="start">


        <lightning-layout-item size="6" large-device-size="3" medium-device-size="3" small-device-size="6"
          padding="around-small">

          <lightning-button type="button" class="slds-m-right_medium fixed-button gray-button" variant="Brand"
            label="+ Product" icon-position="Center" onclick={addProductModal} disabled={isActionButtonsDisabled}>
          </lightning-button>

        </lightning-layout-item>



          <lightning-layout-item size="6" large-device-size="3" medium-device-size="3" small-device-size="6"
          padding="around-small">

          <!-- change kajal -->
          <template if:true={isAddDiscount}>
            <template if:false={isDiscountInputVisible}>
                <template if:false={showDiscountSuccess}>
                    <div class="discount-button-wrapper">
                        <button class="slds-m-right_medium fixed-button gray-button" onclick={handleAddDicountModal} disabled={isActionButtonsDisabled}>
                            <span>+ Discount</span>
                        </button>
                        <template if:true={hasActiveDiscount}>
                            <div class="discount-active-label">
                                <lightning-icon icon-name="utility:check" size="xx-small" class="discount-label-icon"></lightning-icon>
                                <span class="discount-label-text">{discountLabelText}</span>
                            </div>
                        </template>
                    </div>
                </template>
                <template if:true={showDiscountSuccess}>
                     <div class="slds-m-right_medium fixed-button success-indicator slds-align_absolute-center">
                        <lightning-icon icon-name="utility:success" size="small" variant="success"></lightning-icon>
                     </div>
                </template>
            </template>
            <template if:true={isDiscountInputVisible}>
                <div class="slds-m-right_medium fixed-button discount-input-container slds-grid slds-grid_vertical-align-center">
                    <lightning-input type="number" variant="label-hidden" value={discountAmount}
                        onchange={handlerFixedDiscountInput} onkeydown={handleDiscountInputKeydown}
                        class="discount-input" placeholder="Amount" step="0.01">
                    </lightning-input>
                    <lightning-button-icon icon-name="utility:add" variant="bare" onclick={saveDiscount} class="slds-m-left_xx-small"></lightning-button-icon>
                </div>
            </template>
          </template>

          <template if:false={isAddDiscount}>
            <button class="slds-m-right_medium fixed-button gray-button" disabled>
                <span>+ Discount</span>
            </button>
          </template>



          <!-- ALREADY COMMETTED -->
          <!-- <template if:false={includeBundleDiscount}>
            <lightning-button class="slds-m-right_medium fixed-button gray-button" type="button" variant="Neutral"
              label="Add Discount" icon-name="utility:magicwand" icon-position="Center" disabled>
            </lightning-button>
          </template> -->

        </lightning-layout-item>


            <lightning-layout-item size="6" large-device-size="3" medium-device-size="3" small-device-size="6"
          padding="around-small">
            <lightning-button class="slds-m-right_medium fixed-button gray-button" variant="Neutral" label="+ Code"
            icon-position="Center" onclick={handleAdddiscountCodeModal} disabled></lightning-button>
        </lightning-layout-item>

        <lightning-layout-item size="6" large-device-size="3" medium-device-size="3" small-device-size="6"
          padding="around-small">
          <!-- Spark  button start -->
            <button class="spark-button" onclick={handleCalculateBundle} disabled={isActionButtonsDisabled}>
              <svg class="sparkle" viewBox="-60 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M14.187 8.096L15 5.25L15.813 8.096C16.0231 8.83114 16.4171 9.50062 16.9577 10.0413C17.4984 10.5819 18.1679 10.9759 18.903 11.186L21.75 12L18.904 12.813C18.1689 13.0231 17.4994 13.4171 16.9587 13.9577C16.4181 14.4984 16.0241 15.1679 15.814 15.903L15 18.75L14.187 15.904C13.9769 15.1689 13.5829 14.4994 13.0423 13.9587C12.5016 13.4181 11.8321 13.0241 11.097 12.814L8.25 12L11.096 11.187C11.8311 10.9769 12.5006 10.5829 13.0413 10.0423C13.5819 9.50162 13.9759 8.83214 14.186 8.097L14.187 8.096Z"
                  fill="black" stroke="black" stroke-linecap="round" stroke-linejoin="round" />
                <path
                  d="M6 14.25L5.741 15.285C5.59267 15.8785 5.28579 16.4206 4.85319 16.8532C4.42059 17.2858 3.87853 17.5927 3.285 17.741L2.25 18L3.285 18.259C3.87853 18.4073 4.42059 18.7142 4.85319 19.1468C5.28579 19.5794 5.59267 20.1215 5.741 20.715L6 21.75L6.259 20.715C6.40725 20.1216 6.71398 19.5796 7.14639 19.147C7.5788 18.7144 8.12065 18.4075 8.714 18.259L9.75 18L8.714 17.741C8.12065 17.5925 7.5788 17.2856 7.14639 16.853C6.71398 16.4204 6.40725 15.8784 6.259 15.285L6 14.25Z"
                  fill="black" stroke="black" stroke-linecap="round" stroke-linejoin="round" />
                <path
                  d="M6.5 4L6.303 4.5915C6.24777 4.75718 6.15472 4.90774 6.03123 5.03123C5.90774 5.15472 5.75718 5.24777 5.5915 5.303L5 5.5L5.5915 5.697C5.75718 5.75223 5.90774 5.84528 6.03123 5.96877C6.15472 6.09226 6.24777 6.24282 6.303 6.4085L6.5 7L6.697 6.4085C6.75223 6.24282 6.84528 6.09226 6.96877 5.96877C7.09226 5.84528 7.24282 5.75223 7.4085 5.697L8 5.5L7.4085 5.303C7.24282 5.24777 7.09226 5.15472 6.96877 5.03123C6.84528 4.90774 6.75223 4.75718 6.697 4.5915L6.5 4Z"
                  fill="black" stroke="black" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              <span class="text">Calculate</span>
            </button>
          <!-- Spark button end -->
          <!-- <lightning-button type="button" class="slds-m-left_medium fixed-button gray-button" variant="Neutral"
            label="Calculate Discounts" icon-name="utility:percent" icon-position="Center"
            onclick={handleCalculateBundle}></lightning-button> -->
        </lightning-layout-item>


      </lightning-layout>




      <!-- dont remove , will use it  -->
      <!-- <lightning-layout multiple-rows="false" horizontal-align="center">


        <lightning-layout-item size="4" large-device-size="4" medium-device-size="4" small-device-size="4"
          padding="around-small">
          <lightning-button type="button" class="slds-m-left_medium slds-m-right_medium fixed-button gray-button"
            variant="Destructive" label="Empty Basket" icon-name="utility:delete" icon-position="Center"
            onclick={deleteRecord}></lightning-button>
        </lightning-layout-item>
        


      </lightning-layout> -->


      <!-- Start Total Order Value Section - Premium Design -->
      <template if:true={isShowOrderTotal}>
        <div class="order-summary-container">
          <div class="order-summary-header">
            <lightning-icon icon-name="utility:summary" size="x-small" class="summary-header-icon"></lightning-icon>
            <span class="summary-header-text">Order Summary</span>
          </div>
          
          <div class="summary-body">
            <!-- Product Total Row -->
            <div class="summary-row summary-row-primary">
              <div class="summary-label">
                <lightning-icon icon-name="utility:cart" size="xx-small" class="summary-icon"></lightning-icon>
                <span>Product Total</span>
              </div>
              <div class="summary-value summary-value-primary">
                <lightning-formatted-number value={total} format-style="currency" currency-code={isoCode}
                  currency-display-as="symbol"></lightning-formatted-number>
              </div>
            </div>

            <!-- Discounts Section -->
            <div class="discounts-section">
              <div class="summary-row summary-row-discount">
                <div class="summary-label summary-label-indent">
                  <lightning-icon icon-name="utility:bundle_config" size="xx-small" class="discount-icon"></lightning-icon>
                  <span>Product Discounts</span>
                </div>
                <div class="summary-value discount-value">
                  <lightning-formatted-number value={productDiscount} format-style="currency" currency-code={isoCode}
                    currency-display-as="symbol"></lightning-formatted-number>
                </div>
              </div>

              <div class="summary-row summary-row-discount">
                <div class="summary-label summary-label-indent">
                  <lightning-icon icon-name="utility:coupon_codes" size="xx-small" class="discount-icon"></lightning-icon>
                  <span>Discount Codes</span>
                </div>
                <div class="summary-value discount-value">
                  <span class="no-value">â€”</span>
                </div>
              </div>

              <div class="summary-row summary-row-discount">
                <div class="summary-label summary-label-indent">
                  <lightning-icon icon-name="utility:percent" size="xx-small" class="discount-icon"></lightning-icon>
                  <span>Additional Discounts</span>
                </div>
                <div class="summary-value discount-value">
                  <lightning-formatted-number value={fixedDiscountAmount} format-style="currency" currency-code={isoCode}
                    currency-display-as="symbol"></lightning-formatted-number>
                </div>
              </div>
            </div>

            <!-- Subtotal Row (before VAT for excl. VAT markets) -->
            <template if:true={showVatExcludedTotal}>
              <div class="summary-row summary-row-subtotal">
                <div class="summary-label">
                  <lightning-icon icon-name="utility:money" size="x-small" class="subtotal-icon"></lightning-icon>
                  <span>Subtotal</span>
                </div>
                <div class="summary-value summary-value-subtotal">
                  <lightning-formatted-number value={orderTotal} format-style="currency" currency-code={isoCode}
                    currency-display-as="symbol"></lightning-formatted-number>
                </div>
              </div>
            </template>

            <!-- VAT Row - Shows for all markets with VAT configured -->
            <template if:true={hasVatConfig}>
              <div class="summary-row summary-row-vat">
                <div class="summary-label summary-label-indent">
                  <lightning-icon icon-name="utility:cases" size="xx-small" class="vat-icon"></lightning-icon>
                  <span>{vatDisplayText}</span>
                </div>
                <div class="summary-value vat-value">
                  <lightning-formatted-number value={vatAmount} format-style="currency" currency-code={isoCode}
                    currency-display-as="symbol"></lightning-formatted-number>
                </div>
              </div>
            </template>

            <!-- Total Row - Grand Finale -->
            <div class="summary-total-row">
              <div class="summary-label summary-label-total">
                <lightning-icon icon-name="utility:money" size="x-small" class="total-icon"></lightning-icon>
                <template if:true={showVatExcludedTotal}>
                  <span>Total incl. VAT</span>
                </template>
                <template if:false={showVatExcludedTotal}>
                  <span>Total</span>
                </template>
              </div>
              <div class="summary-value summary-value-total">
                <lightning-formatted-number value={grandTotalWithVat} format-style="currency" currency-code={isoCode}
                  currency-display-as="symbol"></lightning-formatted-number>
              </div>
            </div>
          </div>
        </div>
      </template>
      <!-- End Total Order Value Section -->


    </div>




















    <!-- Start Delete Confirmation Modal - Premium Design -->
    <template if:true={isDeleteConfirmationModalOpen}>
      <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true"
        aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
        <div class="confirm-modal-container">
          <div class="confirm-modal-icon-wrapper confirm-modal-icon-warning">
            <lightning-icon icon-name="utility:warning" size="medium"></lightning-icon>
          </div>
          <template if:true={isProductListDelete}>
            <h3 class="confirm-modal-title">Clear Your Basket?</h3>
            <p class="confirm-modal-subtitle">This will remove all products from your basket. This action cannot be undone.</p>
          </template>
          <template if:false={isProductListDelete}>
            <h3 class="confirm-modal-title">Remove Product?</h3>
            <p class="confirm-modal-subtitle">Are you sure you want to remove this product from your basket?</p>
          </template>
          <div class="confirm-modal-actions">
            <button class="modal-btn modal-btn-cancel" onclick={closeModal}>
              <span>Keep Items</span>
            </button>
            <template if:true={isProductListDelete}>
              <button class="modal-btn modal-btn-destructive" onclick={deleteRecordWhenButtonClicked}>
                <lightning-icon icon-name="utility:delete" size="xx-small"></lightning-icon>
                <span>Clear Basket</span>
              </button>
            </template>
            <template if:false={isProductListDelete}>
              <button class="modal-btn modal-btn-destructive" onclick={deleteRecordWhenButtonClicked}>
                <lightning-icon icon-name="utility:delete" size="xx-small"></lightning-icon>
                <span>Remove</span>
              </button>
            </template>
          </div>
        </div>
      </section>
      <div class="slds-backdrop slds-backdrop_open modal-backdrop"></div>
    </template>
    <!-- End Delete Confirmation Modal -->
    <!-- Add Product Modal Start - Premium Design -->
    <template if:true={isAddProductModalOpen}>
      <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-03" aria-modal="true"
        aria-describedby="modal-content-id-3" class="slds-modal slds-fade-in-open slds-modal_medium premium-modal">
        <div class="slds-modal__container modal-container-premium">
          <header class="modal-header-premium">
            <div class="modal-header-content">
              <div class="modal-header-icon">
                <lightning-icon icon-name="utility:add" size="small"></lightning-icon>
              </div>
              <template lwc:if={isShowProductsInAddProductModal}>
                <h2 class="modal-title">Add Products</h2>
              </template>
              <template lwc:elseif={isPricebookNotSelected}>
                <h2 class="modal-title">Select Pricebook</h2>
              </template>
            </div>
            <button class="modal-close-btn" onclick={closeModal} title="Close">
              <lightning-icon icon-name="utility:close" size="small"></lightning-icon>
            </button>
          </header>
          <div class="modal-body-premium modal-body-large" id="modal-content-id-3">
            <!-- Pricebook Icon Picker - shows when 2+ pricebooks and none selected -->
            <template lwc:if={showPricebookIconPicker}>
              <div class="pricebook-icon-picker">
                <p class="pricebook-picker-subtitle">Select a price book to view products</p>
                <div class="pricebook-cards-grid">
                  <template for:each={priceBookIconOptions} for:item="option">
                    <div key={option.value} class="pricebook-selection-card" 
                         data-id={option.value} 
                         onclick={handlePricebookCardSelect}>
                      <div class="pricebook-card-icon">
                        <lightning-icon icon-name={option.icon} size="large"></lightning-icon>
                      </div>
                      <div class="pricebook-card-content">
                        <h3 class="pricebook-card-title">{option.label}</h3>
                      </div>
                      <div class="pricebook-card-arrow">
                        <lightning-icon icon-name="utility:chevronright" size="x-small"></lightning-icon>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </template>
            <!-- Selected pricebook with switcher dropdown -->
            <template lwc:elseif={selectedPriceBookName}>
              <div class="pricebook-switcher">
                <div class="pricebook-current">
                  <lightning-icon icon-name="utility:check" size="xx-small" class="pricebook-check-icon"></lightning-icon>
                  <span class="pricebook-name">{selectedPriceBookName}</span>
                </div>
                <lightning-combobox variant="label-hidden" value={selectedPriceBookIdUsingCombobox}
                  disabled={isPricebookSelectionDisabled} placeholder="Switch Price Book"
                  options={priceBookOptionsForCombobox} onchange={handleSelectionOfPricebook}
                  class="pricebook-dropdown">
                </lightning-combobox>
              </div>
            </template>
            <!-- Fallback combobox for single pricebook (auto-selected) -->
            <template lwc:elseif={isShowComboboxToSelectPricebook}>
              <div class="pricebook-selector">
                <lightning-combobox label="Select Price Book" value={selectedPriceBookIdUsingCombobox}
                  disabled={isPricebookSelectionDisabled} placeholder="Choose a Price Book"
                  options={priceBookOptionsForCombobox} onchange={handleSelectionOfPricebook}
                  class="premium-combobox">
                </lightning-combobox>
              </div>
            </template>
            <template lwc:if={isShowProductsInAddProductModal}>
              <div class="modal-product-list">
                <!-- Product List Header -->
                <div class="modal-product-header">
                  <div class="modal-col-name">Product</div>
                  <div class="modal-col-price">Price</div>
                  <div class="modal-col-qty">Quantity</div>
                </div>
                <!-- Product Rows -->
                <template for:each={currentProductList} for:item="proL" for:index="tabIndex">
                  <div key={proL.Id} class="modal-product-row">
                    <div class="modal-col-name">
                      <div class="modal-product-indicator"></div>
                      <span class="modal-product-name">{proL.Name}</span>
                    </div>
                    <div class="modal-col-price">
                      <lightning-formatted-number value={proL.UnitPrice} format-style="currency"
                        currency-code={proL.Product2.CurrencyIsoCode} currency-display-as="symbol">
                      </lightning-formatted-number>
                    </div>
                    <div class="modal-col-qty">
                      <div class="qty-stepper">
                        <button class="qty-btn qty-btn-minus" data-index={tabIndex} name="subtract" onclick={increaseDecreaseButton}>
                          <lightning-icon icon-name="utility:dash" size="xx-small"></lightning-icon>
                        </button>
                        <lightning-input label="" variant="label-hidden" type="number" name={tabIndex}
                          onchange={changeIntValue} value={proL.quantity} class="qty-input"></lightning-input>
                        <button class="qty-btn qty-btn-plus" data-index={tabIndex} name="add" onclick={increaseDecreaseButton}>
                          <lightning-icon icon-name="utility:add" size="xx-small"></lightning-icon>
                        </button>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </template>
          </div>
          <footer class="modal-footer-premium">
            <button class="modal-btn modal-btn-cancel" onclick={closeModal}>
              <lightning-icon icon-name="utility:close" size="xx-small"></lightning-icon>
              <span>Cancel</span>
            </button>
            <template lwc:if={isShowProductsInAddProductModal}>
              <button class="modal-btn modal-btn-primary" onclick={addProductsToLeadProducts}>
                <lightning-icon icon-name="utility:add" size="xx-small"></lightning-icon>
                <span>Add to Basket</span>
              </button>
            </template>
          </footer>
        </div>
      </section>
      <div class="slds-backdrop slds-backdrop_open modal-backdrop"></div>
    </template>
    <!-- Add Product Modal End -->
    <!-- Add Discount Modal Start -->
    <template if:true={isShowDiscountModal}>
      <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-03" aria-modal="true"
        aria-describedby="modal-content-id-3" class="slds-modal slds-fade-in-open slds-modal_medium">
        <div class="slds-modal__container" style="width:100%">
          <header class="slds-modal__header">
            <h2 class="slds-text-heading_medium slds-hyphenate">Fixed Discount Amount</h2>
          </header>
          <div class="slds-modal__content slds-p-around_small bodyHeight" id="modal-content-id-5">
            <lightning-input type="text" variant="label-hidden" value={fixedDiscountAmount}
              onchange={handlerFixedDiscountInput}>
            </lightning-input>
          </div>
          <footer class="slds-modal__footer">
            <lightning-button type="button" label="Apply" icon-name="utility:add" icon-position="left"
              onclick={handlerFixedDiscount} variant="brand">
            </lightning-button>
            <lightning-button type="button" label="Cancel" icon-name="utility:close" icon-position="left"
              onclick={closeModal} variant="brand" class="addSpaceInFooter">
            </lightning-button>
          </footer>
        </div>
      </section>
      <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
    <!-- Add Discount Modal End -->
    <!-- Add Discount Code Modal Start -->
    <template if:true={isShowDiscountCodeModal}>
      <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-03" aria-modal="true"
        aria-describedby="modal-content-id-3" class="slds-modal slds-fade-in-open slds-modal_medium">
        <div class="slds-modal__container" style="width:100%">
          <header class="slds-modal__header">
            <h2 class="slds-text-heading_medium slds-hyphenate">Add Discount Code</h2>
          </header>
          <div class="slds-modal__content slds-p-around_small bodyHeight" id="modal-content-id-6">
            <!-- <lightning-input type="text" variant="label-hidden" value={fixedDiscountAmount}
              onchange={handlerFixedDiscountInput}>
            </lightning-input> -->
          </div>
          <footer class="slds-modal__footer">
            <!-- <lightning-button type="button" label="Apply" icon-name="utility:add" icon-position="left"
              onclick={handlerFixedDiscount} variant="brand">
            </lightning-button> -->
            <lightning-button type="button" label="Cancel" icon-name="utility:close" icon-position="left"
              onclick={closeModal} variant="brand" class="addSpaceInFooter">
            </lightning-button>
          </footer>
        </div>
      </section>
      <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
    <!-- Add Discount Code Modal End -->



        <lightning-layout multiple-rows="false" horizontal-align="center">

      <lightning-layout-item size="12" large-device-size="12" medium-device-size="12" small-device-size="12"
        padding="around-small">
        
        <div class="payment-actions-row">
            
            <!-- Create Payment Button Components -->
            <template if:false={isOpportunityObjectType}>
              <div class="create-payment-wrapper">
                <c-p-s_-enhanced-create-payment disable-button={disableButton} record-id={recordId}
                  onpaymentcreated={handlePaymentCreated} onpaymentprogress={handlePaymentProgress} hide-create-payment-button={isPaymentCreated}>
                </c-p-s_-enhanced-create-payment>
              </div>
            </template>
            
            <template if:true={isOpportunityObjectType}>
              <div class="create-payment-wrapper">
                <c-dfj_-payment_-for_-opportunity is-on-product-selector='true' disable-create-payment={disableButton}
                  record-id={recordId} onpaymentcreated={handlePaymentCreated} onpaymentprogress={handlePaymentProgress} hide-create-payment-button={isPaymentCreated}>
                </c-dfj_-payment_-for_-opportunity>
              </div>
            </template>

            <!-- Payment Status Component -->
            <div class="payment-status-wrapper">
              <c-dfj_-payment-status record-id={recordId} onpaymentcanceled={handlePaymentCanceled}
                object-api-name={objectApiName} onpaymentfound={handlePaymentFound}
                onpaymentmissing={handlePaymentMissing}></c-dfj_-payment-status>
            </div>
            
        </div>

      </lightning-layout-item>

    </lightning-layout>

    </template>
    <!-- End of hasPermissionError false block -->

  </lightning-card>
  <template if:true={isPaymentInProgress}>
    <div class="payment-overlay">
      <lightning-spinner alternative-text="Generating payment link..." size="medium"></lightning-spinner>
      <div class="overlay-text">Generating payment link...</div>
    </div>
  </template>
  </div>
  <!-- Add Bundle Discount Flow Start -->
  <template if:true={callProductBundleFlow}>
    <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true"
      aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
      <div class="slds-modal__container" style="width:95%">
        <div class="slds-modal__content slds-p-around_small" id="modal-content-id-4">
          <lightning-flow flow-api-name='SF_Add_Bundle_Discounts' flow-input-variables={flowInputVariables}
            onstatuschange={handleStatusChange}>
          </lightning-flow>
        </div>
      </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>
  <!-- Add bundle Discount Flow End -->
</template>